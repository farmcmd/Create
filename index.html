<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水里永續共好聯盟 – 山村永續旅遊</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD3nputPciVexm3dQrBM-LH8cH-fexbDvQ&libraries=geometry,routes&callback=initMap"></script>

    <script type="module" src="script.js"></script>


</head>
<body class="bg-gray-100 text-gray-800 font-sans">

    <header class="bg-green-700 text-white p-6 text-center shadow-md relative">
         <div class="absolute top-3 left-3 text-left text-xs text-gray-200">請使用單一瀏覽器，清除cookie會使紀錄流失</div>
        <h1 class="text-3xl font-bold">水里永續共好聯盟 – 山村永續旅遊</h1>
        <p class="mt-2 text-lg">一起用低碳方式探索美麗水里山村</p>
    </header>

    <main class="container mx-auto p-6 mt-8">

        <section id="homepage" class="page-section block bg-white p-6 rounded-lg shadow-lg">

            <div class="bg-green-50 p-6 rounded-lg shadow-inner mb-8">
                <h3 class="text-2xl font-semibold mb-5 text-green-700 text-center">旅遊管理統計 (您的數據)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="p-4 bg-white rounded-md shadow-sm border border-green-200">
                        <label for="player-name" class="block text-sm font-medium text-gray-700 mb-1">永續旅者姓名:</label>
                        <input type="text" id="player-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50 text-center text-base p-2" placeholder="請輸入您的姓名">
                    </div>
                    <div class="p-4 bg-white rounded-md shadow-sm border border-green-200 text-center flex flex-col justify-center">
                        <p class="text-sm font-medium text-gray-700">您的隨機碼:</p>
                        <p id="player-code" class="mt-1 text-2xl font-bold text-green-600">生成中...</p>
                    </div>
                </div>
                <p id="stats-load-status" class="text-sm text-gray-600 mb-6 text-center">已自動載入之前的旅遊數據...</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                    <div class="p-4 bg-white rounded-md shadow-sm border border-green-200">
                        <p class="text-sm font-medium text-gray-700">累計里程</p>
                        <p id="total-mileage" class="text-2xl font-bold text-green-600">0 km</p>
                    </div>
                    <div class="p-4 bg-white rounded-md shadow-sm border border-green-200">
                        <p class="text-sm font-medium text-gray-700">減碳總量</p>
                        <p id="total-carbon-reduction" class="text-2xl font-bold text-green-600">0 g</p>
                    </div>
                    <div class="p-4 bg-white rounded-md shadow-sm border border-green-200">
                        <p id="total-score" class="text-2xl font-bold text-green-600">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 p-6 rounded-lg shadow-inner mb-8">
                 <h3 class="text-2xl font-semibold mb-5 text-blue-700 text-center">網路累計減碳量 (所有永續旅者)</h3>
                 <div class="text-center">
                     <p class="text-sm font-medium text-gray-700">所有永續旅者累計減碳總量:</p>
                     <p id="network-total-carbon-reduction" class="mt-1 text-3xl font-bold text-blue-600">載入中...</p>
                     <p id="network-stats-status" class="text-xs text-gray-600 mt-2">從伺服器載入中...</p>
                 </div>
            </div>


            <h2 class="text-2xl font-semibold mb-6 text-green-800 text-center">選擇您的低碳交通方式</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6 mb-8">
                <button class="transport-option flex flex-col items-center p-5 bg-green-100 rounded-lg shadow hover:bg-green-200 transition-all duration-300 ease-in-out" data-transport="bike" data-carbon-reduction="350">
                    <span class="text-3xl mb-3">🚲</span>
                    <span class="font-semibold text-center text-sm">腳踏車</span>
                    <span class="text-xs text-gray-600 mt-2 text-center">減碳數據: 約 350g/10km</span>
                    <span class="text-xs text-gray-500 mt-1 text-center">好處: 彈性高、健身、深度體驗</span>
                </button>
                <button class="transport-option flex flex-col items-center p-5 bg-green-100 rounded-lg shadow hover:bg-green-200 transition-all duration-300 ease-in-out" data-transport="walk" data-carbon-reduction="400">
                    <span class="text-3xl mb-3">🚶‍♂️</span>
                    <span class="font-semibold text-center text-sm">步行</span>
                    <span class="text-xs text-gray-600 mt-2 text-center">減碳數據: 約 400g/10km</span>
                    <span class="text-xs text-gray-500 mt-1 text-center">好處: 最低碳、細細品味、健康</span>
                </button>
                <button class="transport-option flex flex-col items-center p-5 bg-green-100 rounded-lg shadow hover:bg-green-200 transition-all duration-300 ease-in-out" data-transport="bus_train" data-carbon-reduction="300">
                    <span class="text-3xl mb-3">🚌</span>
                    <span class="font-semibold text-center text-sm">共乘巴士 (公車/火車/遊覽巴士)</span>
                    <span class="text-xs text-gray-600 mt-2 text-center">減碳數據: 約 300g/人/10km</span>
                    <span class="text-xs text-gray-500 mt-1 text-center">好處: 輕鬆便利、減少交通壓力</span>
                </button>
                <button class="transport-option flex flex-col items-center p-5 bg-green-100 rounded-lg shadow hover:bg-green-200 transition-all duration-300 ease-in-out" data-transport="carpool_2_moto" data-carbon-reduction="100">
                    <span class="text-3xl mb-3">🏍️🚗</span>
                    <span class="font-semibold text-center text-sm">私家車共乘 2 人 / 摩托車</span>
                    <span class="text-xs text-gray-600 mt-2 text-center">減碳數據: 約 100g/人/10km</span>
                    <span class="text-xs text-gray-500 mt-1 text-center">好處: 分攤費用、減少車輛數</span>
                </button>
                <button class="transport-option flex flex-col items-center p-5 bg-green-100 rounded-lg shadow hover:bg-green-200 transition-all duration-300 ease-in-out" data-transport="carpool_3" data-carbon-reduction="120">
                    <span class="text-3xl mb-3">🚗</span>
                    <span class="font-semibold text-center text-sm">私家車共乘 3 人</span>
                    <span class="text-xs text-gray-600 mt-2 text-center">減碳數據: 約 120g/人/10km</span>
                    <span class="text-xs text-gray-500 mt-1 text-center">好處: 更有效率的共乘</span>
                </button>
                <button class="transport-option flex flex-col items-center p-5 bg-green-100 rounded-lg shadow hover:bg-green-200 transition-all duration-300 ease-in-out" data-transport="carpool_4" data-carbon-reduction="150">
                    <span class="text-3xl mb-3">🚗</span>
                    <span class="font-semibold text-center text-sm">私家車共乘 4 人</span>
                    <span class="text-xs text-gray-600 mt-2 text-center">減碳數據: 約 150g/人/10km</span>
                    <span class="text-xs text-gray-500 mt-1 text-center">好處: 顯著減少碳排</span>
                </button>
                 <button class="transport-option flex flex-col items-center p-5 bg-green-100 rounded-lg shadow hover:bg-green-200 transition-all duration-300 ease-in-out" data-transport="carpool_5" data-carbon-reduction="200">
                     <span class="text-3xl mb-3">🚗</span>
                     <span class="font-semibold text-center text-sm">私家車共乘 5 人</span>
                     <span class="text-xs text-gray-600 mt-2 text-center">減碳數據: 約 200g/人/10km</span>
                     <span class="text-xs text-gray-500 mt-1 text-center">好處: 最佳共乘效率</span>
                 </button>
                 <button class="transport-option flex flex-col items-center p-5 bg-blue-100 rounded-lg shadow hover:bg-blue-200 transition-all duration-300 ease-in-out" data-transport="thsr_haoxing" data-carbon-reduction="0">
                     <span class="text-3xl mb-3">🚄🚌</span>
                     <span class="font-semibold text-center text-sm">高鐵假期x台灣好行</span>
                     <span class="text-xs text-gray-600 mt-2 text-center">減碳數據: 請參考專案說明</span>
                     <span class="text-xs text-gray-500 mt-1 text-center">好處: 輕鬆串聯城鄉</span>
                 </button>
                 <button class="transport-option flex flex-col items-center p-5 bg-yellow-100 rounded-lg shadow hover:bg-yellow-200 transition-all duration-300 ease-in-out" id="taxi-info-button">
                     <span class="text-3xl mb-3">🚕</span>
                     <span class="font-semibold text-center text-sm">我要預約多元計程車導覽旅遊</span>
                      <span class="text-xs text-gray-500 mt-1 text-center">點擊查看資訊</span>
                 </button>
            </div>

            <div id="thsr-info" class="hidden"></div>

             <div class="bg-gray-100 p-6 rounded-lg shadow-inner mb-8">
                 <h3 class="text-2xl font-semibold mb-5 text-gray-700 text-center">更多活動與資訊</h3>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                     <a href="https://drive.google.com/drive/folders/1en2b6PB8A-uxDubopiyW99uUKbUjlqcp?usp=sharing" id="latest-activity-link" target="_blank" class="block p-4 bg-green-600 text-white font-bold rounded-lg shadow hover:bg-green-700 transition-all duration-300 ease-in-out">
                         最新活動報名連結
                         </a>
                     <a href="https://www.facebook.com/groups/321305484230739" target="_blank" class="block p-4 bg-green-600 text-white font-bold rounded-lg shadow hover:bg-green-700 transition-all duration-300 ease-in-out">
                         社團活動資訊
                     </a>
                     <a href="https://www.facebook.com/groups/4309026639329636" target="_blank" class="block p-4 bg-green-600 text-white font-bold rounded-lg shadow hover:bg-green-700 transition-all duration-300 ease-in-out">
                         永續優等生社團
                     </a>
                 </div>
                 <div class="mt-6 text-center">
                     <button id="download-data-button" class="px-8 py-4 bg-blue-700 text-white font-bold rounded-lg shadow hover:bg-blue-800 transition-all duration-300 ease-in-out text-lg">
                         下載永續旅遊數據 (.html) <i class="fas fa-download ml-2"></i>
                     </button>
                 </div>
             </div>


            <div class="bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800 p-5 mb-8 rounded-md" role="alert">
                <p class="font-bold text-yellow-900 mb-2">永續旅遊小貼士 Tips</p>
                <p class="mt-2 animate-pulse-subtle text-gray-700">
                    選擇低碳交通工具及低碳減塑旅宿，攜帶環保旅具包含盥洗用具、拖鞋、購物袋、餐具等。
                    進入農場不隨意摘採與踩踏，野外請遵循生態旅遊原則，留意沿途警示牌，不干擾野生動物，不採摘植物，並帶走所有垃圾。
                </p>
            </div>


            <div class="text-center text-sm text-gray-600 mt-10">
                <p class="mb-3 font-semibold">共同開發單位：</p>
                <ul class="list-disc list-inside mx-auto w-fit text-left mt-3 text-gray-700">
                    <li>社團法人南投縣水里鄉商圈創生共好協會</li>
                    <li>社團法人南投縣青年農民永續發展協會</li>
                    <li>水里里山基地#<a href="https://www.facebook.com/Satoyamadining" target="_blank" class="text-green-600 hover:underline">里山餐桌</a>團隊 #水里青農</li>
                    <li>國立臺灣大學USR「臺大．山林．學院2.0」#水里營林區</li>
                    <li>山形兒童活動工作室 Wild Kids Studio</li>
                </ul>
                <p class="mt-6 text-gray-700">© 2025 水里永續共好聯盟。版權所有。</p>
                <p class="mt-2 text-gray-700">V2.1，歡迎至FACEBOOK粉專「<a href="https://www.facebook.com/Satoyamadining" target="_blank" class="text-green-600 hover:underline">里山餐桌</a>」提出建議。</p>
                <p class="mt-2 text-gray-700">本聯盟不定時舉辦永續積分競賽活動，競賽期間依據版本編號及積分領取活動獎品。</p>
                <p class="font-semibold text-orange-600 mt-4">注意：版本更新時將新增景點與任務；不同版本之間旅遊數據不互通。</p>
            </div>

        </section>

        <section id="mission-page" class="page-section bg-white p-6 rounded-lg shadow-lg">
             <h2 class="text-2xl font-semibold mb-6 text-green-800 text-center">您的永續旅遊任務</h2>
             <button id="back-to-home" class="mb-6 px-6 py-3 bg-gray-300 rounded-lg hover:bg-gray-400 transition-all duration-300 ease-in-out"><i class="fas fa-arrow-left mr-2"></i>返回首頁</button>
             <button id="change-transport-button" class="mb-6 ml-4 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all duration-300 ease-in-out"><i class="fas fa-car-side mr-2"></i>更換交通方式</button>
             <div class="mb-8 p-4 bg-green-100 rounded-md shadow-sm border border-green-200">
                 <p class="font-semibold text-gray-700">目前交通方式: <span id="current-transport-display" class="text-green-800 font-bold">未選擇</span></p>
             </div>


            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 bg-gray-200 rounded-lg overflow-hidden shadow-md p-6">
                <div class="lg:col-span-2">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">地圖探索</h3>
                    <div id="map"></div>
                     <div id="map-status" class="text-center text-sm text-gray-600 mt-4">
                         地圖載入中... (等待 Google Maps API)
                         <br>
                         <span class="text-xs">若地圖未正確載入，請利用景點列表中的 <i class="fas fa-car-side text-orange-500"></i> 圖示記錄您的里程。</span>
                     </div>
                     <div class="p-4 bg-gray-300 text-center mt-4 rounded-md">
                         <p class="mt-2 text-sm text-gray-700">請從下方景點列表或地圖上選擇起點和終點</p>
                         <p id="selected-points-display" class="mt-2 text-base font-semibold text-green-800">起點: 未選擇 | 終點: 未選擇</p>
                         <button id="calculate-mileage-button" class="mt-5 px-8 py-4 bg-green-600 text-white font-bold rounded-lg shadow hover:bg-green-700 transition-all duration-300 ease-in-out text-lg"><i class="fas fa-route mr-2"></i> 計算本次旅程里程與減碳</button>
                         <p id="trip-calculation-status" class="mt-4 text-sm font-semibold text-gray-700"></p>
                     </div>
                </div>

                <div class="lg:col-span-1 flex flex-col gap-6">

                    <div class="bg-gray-50 p-4 rounded-lg shadow-md overflow-y-auto max-h-[70vh]">
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">景點列表</h3>
                        <ul id="poi-list" class="space-y-3">
                            <li class="text-gray-500 text-center">載入景點中...</li>
                        </ul>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">永續行動與活動</h3>
                         <p class="text-sm text-green-800 font-bold mb-4">
                             紀錄您在這趟旅程中做出對環境維護、永續生產、生態保護、人與自然和平共處的生活態度，讓永續精神實踐在您的生活中。
                         </p>

                        <div class="mb-6 pb-4 border-b border-gray-200">
                            <h4 class="text-lg font-medium mb-3 text-gray-600">記錄您的永續行動 (選擇項目並填寫紀錄獲得積分)</h4>
                            <div id="selectable-actions-list" class="mb-4 space-y-2">
                                <p class="text-gray-500 text-center">載入行動項目中...</p>
                            </div>

                            <textarea id="sustainable-action-log" class="w-full p-3 border rounded-md focus:outline-none focus:ring focus:border-green-500 text-sm" rows="4" placeholder="請在此輸入您具體的永續行動記錄..."></textarea>
                            <button id="log-action-button" class="mt-3 px-6 py-3 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition-all duration-300 ease-in-out text-sm"><i class="fas fa-check-circle mr-2"></i>記錄行動並獲得積分</button>
                            <p id="action-log-status" class="mt-3 text-sm font-semibold text-gray-600"></p>
                        </div>

                        <div class="mb-6 pb-4 border-b border-gray-200">
                             <h4 class="text-lg font-medium mb-3 text-gray-600">永續山村任務活動 (選擇活動後點擊參加按鈕)</h4>
                             <p class="text-sm text-green-800 font-bold mb-4">
                                 任務活動非定期舉辦，建議您在出發前，透過各景點的粉絲專頁或社團瞭解活動資訊!
                             </p>
                             <ul id="activity-list" class="space-y-2 text-sm text-gray-700 mb-4">
                                 <li class="text-gray-500 text-center">載入活動中...</li>
                             </ul>
                             <button id="participate-activity-button" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-all duration-300 ease-in-out text-sm"><i class="fas fa-calendar-check mr-2"></i>參加活動 (輸入驗證碼與內容)</button>
                         </div>

                         <div class="bg-green-50 p-4 rounded-lg shadow-inner max-h-[300px] overflow-y-auto border border-green-200">
                             <h4 class="lg font-medium mb-3 text-gray-600">我的行動紀錄</h4>
                             <div id="logged-actions-list" class="space-y-3">
                                 <p class="text-gray-500 text-center">尚無行動紀錄</p>
                             </div>
                         </div>

                    </div>
                </div>
            </div>
        </section>

    </main>

    <div id="poi-modal" class="modal-overlay hidden">
        <div class="modal-content shadow-xl">
            <span class="close-button">×</span>
            <h3 id="poi-modal-title" class="text-2xl font-bold mb-4 text-green-800">景點標題</h3>
            <img id="poi-modal-image" src="" alt="景點圖片" class="mb-4 hidden">
            <div class="poi-modal-content-body">
                 <p id="poi-modal-description" class="text-gray-700 leading-relaxed"></p>
                 <p id="poi-modal-coordinates" class="text-sm text-gray-600 mt-4"></p>
                 <div id="poi-modal-social" class="mt-4 text-sm">
                 </div>
                 <div id="poi12-buttons" class="mt-6 hidden flex flex-col space-y-3">
                      <a href="https://farmcbd.my.canva.site/dagl50o3mt8" target="_blank" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700 transition-all duration-300 ease-in-out text-center"><i class="fas fa-gamepad mr-2"></i>水里四季梅遊小遊戲</a>
                      <button id="sroi-order-button-poi12" class="px-6 py-3 bg-purple-600 text-white font-bold rounded-lg shadow hover:bg-purple-700 transition-all duration-300 ease-in-out text-center"><i class="fas fa-leaf mr-2"></i>SROI生態棲地農產品訂購&ESG企業採購表單</button>
                 </div>
                 <div id="sroi-info-button-container" class="mt-6 hidden">
                     <button id="show-sroi-info-button" class="w-full px-6 py-3 bg-purple-600 text-white font-bold rounded-lg shadow hover:bg-purple-700 transition-all duration-300 ease-in-out text-center"><i class="fas fa-leaf mr-2"></i>SROI生態棲地農產品訂購&ESG企業採購表單</button>
                 </div>

                 <div id="poi17-consumption-section" class="mt-6 pt-4 border-t border-gray-200 hidden">
                     <h4 class="text-xl font-semibold mb-4 text-green-700 text-center">【永續消費獲里程】</h4>
                     <p class="text-sm text-gray-700 mb-4 text-center">請選擇消費類別，並輸入店家提供的5碼數字驗證碼</p>
                     <div id="consumption-buttons" class="grid grid-cols-2 gap-3 mb-4">
                         <button class="consumption-button px-4 py-2 bg-green-200 rounded-md hover:bg-green-300 transition-colors text-sm" data-mileage-points="5" data-carbon-reduction="20" data-label="農產品">農產品 (5里程/20g)</button>
                         <button class="consumption-button px-4 py-2 bg-green-200 rounded-md hover:bg-green-300 transition-colors text-sm" data-mileage-points="3" data-carbon-reduction="12" data-label="在地小吃">在地小吃 (3里程/12g)</button>
                         <button class="consumption-button px-4 py-2 bg-green-200 rounded-md hover:bg-green-300 transition-colors text-sm" data-mileage-points="2" data-carbon-reduction="8" data-label="文創商品">文創商品 (2里程/8g)</button>
                         <button class="consumption-button px-4 py-2 bg-green-200 rounded-md hover:bg-green-300 transition-colors text-sm" data-mileage-points="2" data-carbon-reduction="8" data-label="服務類">服務類 (2里程/8g)</button>
                         <button class="consumption-button px-4 py-2 bg-green-200 rounded-md hover:bg-green-300 transition-colors text-sm" data-mileage-points="2" data-carbon-reduction="8" data-label="其他">其他 (2里程/8g)</button>
                     </div>
                      <div class="mb-4">
                         <label for="consumption-code-input" class="block text-sm font-medium text-gray-700 mb-1">5碼數字驗證碼:</label>
                         <input type="text" id="consumption-code-input" class="w-full p-2 border rounded-md focus:outline-none focus:ring focus:border-green-500 text-sm" maxlength="5" placeholder="請輸入5碼數字">
                      </div>
                     <button id="submit-consumption" class="w-full px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow hover:bg-green-700 transition-all duration-300 ease-in-out text-lg"><i class="fas fa-check-circle mr-2"></i>記錄消費並獲得里程與減碳</button>
                     <p id="consumption-status" class="mt-3 text-sm font-semibold text-gray-600 text-center"></p>
                 </div>


            </div>

            <div class="mt-6 flex justify-end space-x-4">
                 <button id="set-as-start-button" class="px-6 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-all duration-300 ease-in-out"><i class="fas fa-map-marker-alt mr-2"></i>設定為起點</button>
                 <button id="set-as-end-button" class="px-6 py-3 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition-all duration-300 ease-in-out"><i class="fas fa-flag-checkered mr-2"></i>設定為終點</button>
             </div>
        </div>
    </div>

    <div id="activity-modal" class="modal-overlay hidden">
        <div class="modal-content shadow-xl">
            <span class="close-button">×</span>
            <h3 class="text-2xl font-bold mb-4 text-green-800">參加活動：<span id="selected-activity-name"></span></h3>
            <img id="activity-modal-image" src="" alt="活動相關圖片" class="mb-4 hidden">
            <p class="mb-2 text-gray-700">請輸入活動驗證碼</p>
            <input type="text" id="verification-code-input" class="w-full p-3 border rounded-md mb-4 focus:outline-none focus:ring focus:border-green-500">
            <p class="mb-2 text-gray-700">請輸入活動內容或課程名稱</p>
            <textarea id="activity-content-input" class="w-full p-3 border rounded-md mb-4 focus:outline-none focus:ring focus:border-green-500" rows="3" placeholder="例如：參加了里山倡議食農下午茶講堂，學習製作香草餅乾"></textarea>
            <button id="submit-activity-log" class="px-6 py-3 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition-all duration-300 ease-in-out text-sm"><i class="fas fa-check-square mr-2"></i>記錄活動並獲得積分</button>
            <p id="activity-log-status" class="mt-4 text-sm font-semibold text-gray-700"></p>
        </div>
    </div>

    <div id="thsr-info-modal" class="modal-overlay hidden">
        <div class="modal-content shadow-xl">
            <span class="close-button">×</span>
            <h3 class="text-2xl font-bold mb-4 text-blue-800">高鐵假期x台灣好行 交通資訊</h3>
            <div class="text-gray-700 leading-relaxed">
                <p class="mb-3">您已抵達水里小鎮，感謝您使用高鐵假期做為您的減碳旅遊方式，以下是我們提供給您的交通與住宿資訊:</p>
                <p class="mb-3">台灣高鐵X台鐵台中干城站 > 台灣好行6333D集集線 > 到水里</p>
                <p class="mb-4">
                    水里台灣好行到 >
                    <a href="https://www.taiwantrip.com.tw/Frontend/Route/Select_p?RouteID=R0096" target="_blank" class="text-blue-600 hover:underline font-semibold">6288雙龍線</a> >
                    <a href="https://www.taiwantrip.com.tw/Frontend/Route/Select_p?RouteID=R0061" target="_blank" class="text-blue-600 hover:underline font-semibold">6671車程線</a> >
                    <a href="https://www.taiwantrip.com.tw/Frontend/Route/Select_p?RouteID=R0068" target="_blank" class="text-blue-600 hover:underline font-semibold">6734、6732東埔線</a>。
                 </p>
                <p class="mb-4">住宿建議請參考景點 > 環保旅宿推薦。</p>
            </div>
        </div>
    </div>

     <div id="log-trip-modal" class="modal-overlay hidden">
        <div class="modal-content shadow-xl">
            <span class="close-button">×</span>
            <h3 class="text-2xl font-bold mb-4 text-orange-700">記錄前往景點的旅程</h3>
            <p class="mb-4 text-gray-700">您正在記錄前往：<span id="log-trip-poi-name" class="font-semibold text-green-800"></span></p>
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">選擇交通方式:</label>
                <div id="log-trip-transport-options" class="flex flex-wrap gap-3">
                </div>
                 <p id="log-trip-transport-status" class="mt-3 text-sm font-semibold text-red-600 hidden">請選擇交通方式。</p>
             </div>

            <div class="mb-6">
                <label for="log-trip-mileage" class="block text-sm font-medium text-gray-700 mb-3">輸入抵達里程數 (公里):</label>
                <input type="number" id="log-trip-mileage" class="w-full p-3 border rounded-md focus:outline-none focus:ring focus:border-green-500" step="0.1" min="0" placeholder="例如: 5.2">
                <p id="log-trip-mileage-status" class="mt-3 text-sm font-semibold text-red-600 hidden">請輸入有效的里程數。</p>
            </div>

            <div class="mt-6 flex justify-end">
                <button id="submit-log-trip" class="px-8 py-4 bg-orange-600 text-white font-bold rounded-lg shadow hover:bg-orange-700 transition-all duration-300 ease-in-out text-lg"><i class="fas fa-road mr-2"></i>記錄旅程並計算減碳/分數</button>
            </div>
             <p id="log-trip-status" class="mt-4 text-sm font-semibold text-gray-700"></p>
         </div>
    </div>

    <div id="taxi-info-modal" class="modal-overlay hidden">
        <div class="modal-content shadow-xl">
            <span class="close-button">×</span>
            <h3 class="text-2xl font-bold mb-4 text-yellow-700">多元計程車導覽旅遊資訊</h3>
            <div class="text-gray-700 leading-relaxed">
                <p class="mb-2"><strong>車號:</strong> TBD-5339</p>
                <p class="mb-2"><strong>駕駛人:</strong> 詹聖慈</p>
                <p class="mb-2"><strong>營業時間:</strong> 9:00~20:00</p>
                <p class="mb-2"><strong>旅遊範圍:</strong> 水里鄉、信義鄉、日月潭</p>
                <p class="mb-2"><strong>最大乘客數:</strong> 4</p>
                <p class="mb-2"><strong>駕駛人永續旅遊導覽培訓時數:</strong> 12/時</p>
                <p class="mb-2"><strong>預約叫車電話:</strong> 0980-015-339</p>
                <p class="mb-2"><strong>LINE ID:</strong> 未提供</p>
            </div>
             <p class="mt-6 text-sm text-gray-600">若有需求請於出發一周前直接聯繫駕駛人預約及確認詳細資訊。</p>
        </div>
    </div>

    <div id="sroi-info-modal" class="modal-overlay hidden">
        <div class="modal-content shadow-xl">
            <span class="close-button">×</span>
            <h3 class="text-2xl font-bold mb-4 text-purple-700">SROI生態棲地農產品訂購&ESG企業採購資訊</h3>
             <p class="mb-4 text-gray-700">景點：<span id="sroi-modal-poi-name" class="font-semibold text-green-800"></span></p>
            <div id="sroi-modal-content-body" class="text-gray-700 leading-relaxed space-y-3">
                 </div>
        </div>
    </div>


    </body>
</html>
```


```javascript
// script.js

// Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, getDocs, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";


// --- Firebase Configuration ---
// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
    apiKey: "AIzaSyCEH65YbNirj_IRmtsIJZS-HNEbsRBBsSQ", // Your Firebase API Key
    authDomain: "sustainable-tourism-65025.firebaseapp.com",
    projectId: "sustainable-tourism-65025",
    storageBucket: "sustainable-tourism-65025.firebasestorage.app",
    messagingSenderId: "781325465882",
    appId: "1:781325465882:web:9435b02bd618f0c16814a3",
    measurementId: "G-SZJ1RX5QS4"
};

// Initialize Firebase
let app;
let db;
let analytics;

try {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app); // Get a reference to the Firestore service using the new method
    analytics = getAnalytics(app); // Get a reference to the Analytics service using the new method
     console.log("Firebase initialized successfully."); // Debugging line
     // Initial fetch of network total after Firebase is initialized
     // This will now happen when loadData is called on DOMContentLoaded
     // fetchNetworkTotalCarbonReduction(); // This is called in loadData now

} catch (error) {
     console.error("Error initializing Firebase:", error); // Debugging line
     // Update network stats status on Firebase initialization error
     const networkStatsStatusElement = document.getElementById('network-stats-status');
      if (networkStatsStatusElement) {
          networkStatsStatusElement.textContent = `Firebase 初始化失敗: ${error.message}. 無法載入網路統計。`;
          networkStatsStatusElement.classList.remove('text-gray-600', 'text-green-600');
          networkStatsStatusElement.classList.add('text-red-600');
      }
      const networkTotalCarbonReductionElement = document.getElementById('network-total-carbon-reduction');
      if (networkTotalCarbonReductionElement) {
           networkTotalCarbonReductionElement.textContent = '載入失敗';
      }
}


// --- Data Definitions ---
// Define transportData here, outside initMap, with placeholder travelMode
let transportData = {
    // Added metersPerPoint for score calculation based on distance
    bike: { name: '腳踏車', icon: '🚲', carbonReductionPer10km: 350, travelMode: null, metersPerPoint: 10000 }, // 10km = 10000m
    walk: { name: '步行', icon: '🚶‍♂️', carbonReductionPer10km: 400, travelMode: null, metersPerPoint: 8000 },   // 8km = 8000m
    bus_train: { name: '共乘巴士 (公車/火車/遊覽巴士)', icon: '🚌', carbonReductionPer10km: 300, travelMode: null, metersPerPoint: 15000 }, // 15km = 15000m
    carpool_2_moto: { name: '私家車共乘 2 人 / 摩托車', icon: '🏍️🚗', carbonReductionPer10km: 100, travelMode: null, metersPerPoint: 25000 }, // 25km = 25000m
    carpool_3: { name: '私家車共乘 3 人', icon: '🚗', carbonReductionPer10km: 120, travelMode: null, metersPerPoint: 20000 }, // 20km = 20000m
    carpool_4: { name: '私家車共乘 4 人', icon: '🚗', carbonReductionPer10km: 150, travelMode: null, metersPerPoint: 18000 }, // 18km = 18000m
    carpool_5: { name: '私家車共乘 5 人', icon: '🚗', carbonReductionPer10km: 200, travelMode: null, metersPerPoint: 16000 }, // 16km = 16000m
    thsr_haoxing: { name: '高鐵假期x台灣好行', icon: '🚄🚌', carbonReductionPer10km: 0, travelMode: null, metersPerPoint: Infinity } // THSR doesn't get points from distance in this model
    // Taxi info is not included here as it's not for mileage calculation
};


// Points of Interest Data (Removed iconUrl for default markers)
const pois = [
    // Removed 'iconUrl' property to use default Google Maps markers
    // 'socialLink' property is kept for external links.
    { id: 'poi1', name: '水里永續共好聯盟打氣站', coords: { lat: 23.809799, lng: 120.849286 }, icon: '🌲', description: '營業時間上午8:00~17:00。\n\n不定期辦理活動，小尖兵們完成的永續任務的分數請在此出示，感謝您一起為地球減碳努力!\n\n本區共分為三個單位(水里鄉圖書館內):\n1. 社團法人南投縣水里鄉商圈創生共好協會 - 致力於推動水里地區商圈振興、永續農業、文化保存與地方創生行動。以多元合作模式打造出一個能共好、共學、共榮的地方創新平台。\n2. 水里溪畔驛站 - 在圖書館內的一處靜懿的景觀休憩場域，小農午餐需要事先預訂喔!\n3. 水里青農里山基地 - 是由臺大實驗林水里營林區輔導的里山餐桌團隊打造的里山及永續教育基地，由返鄉青農共同打造的農業與社區發展平台，以農村生產、生活、生態致力於推廣友善農業、食農教育及永續發展為目標。在這裡可以預約由小農開發的豐富教具進行DIY活動與食農、永續教育等活動!', image: '', socialLink: 'https://www.facebook.com/p/%E6%B0%B4%E9%87%8C%E9%84%89%E5%95%86%E5%9C%88%E5%89%B5%E7%94%9F%E5%85%B1%E5%A5%BD%E5%8D%94%E6%9C%83-100076220760859/?locale=zh_TW' },
    { id: 'poi2', name: '漫遊堤岸風光', coords: { lat: 23.808537, lng: 120.849415 }, icon: '🏞️', description: '起點：水里親水公園。終點：永興村，途中經過社子生態堤防、永興大橋、永興社區等地，路線全長約4公里，坡度平緩，適合親子及大眾。', image: '' },
    { id: 'poi3', name: '鑫鮮菇園', coords: { lat: 23.794049, lng: 120.859407 }, icon: '🍄', description: '營業時間: 需預約。\n\n提供香菇園區種植導覽與體驗行程 (時長20分鐘)。\n香菇/袖珍菇三角飯糰食農體驗(時長90分鐘)。', image: '', socialLink: 'https://www.facebook.com/xinxianguyuan', sroiInfo: { reportLink: 'YOUR_REPORT_LINK_3', formLink: 'YOUR_FORM_LINK_3', lineId: 'YOUR_LINE_ID_3' } }, // Added sroiInfo
    { id: 'poi4', name: '永興神木', coords: { lat: 23.784127, lng: 120.862294 }, icon: '🌳', description: '社區麵包坊營業時間”上午9:00~17:00。\n\n永興神木（百年大樟樹）位於永興社區活動中心旁。樟樹群由三棵母子樹所形成，第一代木就是母樹，二代木則是母樹根系再長出的兩棵子樹，連成一體。樹齡約300年、樹圍6.2公尺、樹徑1.6公尺、樹高約26公尺、樹冠幅400平方公尺，一旁供俸老樹公及福德祠是居民的信仰中心。\n\n社區活動中心二樓設有社區麵包坊，由北海扶輪社、臺大實驗林、水里商工，共同扶持社區成立，利用當地種植的果物製作的吐司產品是新鮮別具風味的暢銷品。', image: '', socialLink: 'https://www.shli.gov.tw/story/1/6' },
    { id: 'poi5', name: '森林小白宮', coords: { lat: 23.779408, lng: 120.844019 }, icon: '🏠', description: '接駁、共乘、摩托。需預約。\n\n完成單一活動可獲得永續與環境教育任務點數10點。\n\n小白宮森林生態導覽，親子活動(彩繪/木藝/親子皮影)。', image: '', socialLink: 'https://wild-kids-studio.waca.tw/' },
    { id: 'poi6', name: '瑪路馬咖啡莊園', coords: { lat: 23.778239, lng: 120.843859 }, icon: '☕', description: '接駁、共乘、摩托。\n\n活動資訊: 咖啡座、咖啡園導覽。完成單一活動可獲得永續與環境教育任務點數10點。', image: '', socialLink: 'https://www.facebook.com/people/%E9%A6%AC%E8%B7%AF%E7%91%AA%E5%92%96%E5%95%A1%E8%8E%8A%E5%9C%92/100063961898841/' },
    { id: 'poi7', name: '指令教育農場', coords: { lat: 23.802776, lng: 120.864715 }, icon: '👆', description: '台灣好行、共乘、摩托。\n\n活動資訊: 農場導覽、生態導覽、食農教育。完成單一活動可獲得永續與環境教育任務點數10點。', image: '', socialLink: 'https://www.facebook.com/FarmCMD/', sroiInfo: { reportLink: 'YOUR_REPORT_LINK_7', formLink: 'YOUR_FORM_LINK_7', lineId: 'YOUR_LINE_ID_7' } }, // Added sroiInfo
    { id: 'poi8', name: '明揚養蜂', coords: { lat: 23.803787, lng: 120.862401 }, icon: '🐝', description: '共乘、台灣好行、摩托。\n\n活動資訊: 育蜂場導覽、生態導覽、蜂蜜食農教育。完成單一活動可獲得永續與環境教育任務點數10點。', image: '', socialLink: 'https://www.facebook.com/MingYangBee/?locale=zh_TW', sroiInfo: { reportLink: 'YOUR_REPORT_LINK_8', formLink: 'YOUR_FORM_LINK_8', lineId: 'YOUR_LINE_ID_8' } }, // Added sroiInfo
    { id: 'poi9', name: '蛇窯文化園區', coords: { lat: 23.801177, lng: 120.864479 }, icon: '🏺', description: '共乘、台灣好行。\n\n活動資訊: 購票入園，完成食農器皿文化參觀可獲得永續與環境教育點數10點。', image: '', socialLink: 'https://www.facebook.com/sskshop/?locale=zh_TW' },
    { id: 'poi10', name: '雨社山下', coords: { lat: 23.790644, lng: 120.896569 }, icon: '🥒', description: '接駁、共乘、摩托。\n\n活動資訊: 農場導覽、生態導覽、食農教育。完成單一活動可獲得永續與環境教育任務點數10點。', image: '', socialLink: 'https://www.facebook.com/profile.php?id=61557727713841&locale=zh_TW', sroiInfo: { reportLink: 'YOUR_REPORT_LINK_10', formLink: 'YOUR_FORM_LINK_10', lineId: 'YOUR_LINE_ID_10' } }, // Added sroiInfo
    { id: 'poi11', name: '阿爾喜莊園', coords: { lat: 23.803119, lng: 120.926340 }, icon: '🍋', description: '接駁、共乘、摩托。\n\n活動資訊: 農場導覽、生態導覽、食農教育、農業循環經濟教學。完成單一活動可獲得永續與環境教育任務點數10點。', image: '', socialLink: 'https://www.facebook.com/AHEIemon?locale=zh_TW', sroiInfo: { reportLink: 'YOUR_REPORT_LINK_11', formLink: 'YOUR_FORM_LINK_11', lineId: 'YOUR_LINE_ID_11' } }, // Added sroiInfo
    // Re-added sroiInfo for poi12
    { id: 'poi12', name: '湧健酪梨園', coords: { lat: 23.725349, lng: 120.846123 }, icon: '🥑', description: '台灣好行、共乘、摩托。\n\n活動資訊: 農場導覽、生態導覽、食農教育。完成單一活動可獲得永續與環境教育任務點數10點。', image: '', socialLink: 'https://www.facebook.com/profile.php?id=100085673588742&locale=zh_TW', sroiInfo: { reportLink: 'YOUR_REPORT_LINK_12', formLink: 'YOUR_FORM_LINK_12', lineId: 'YOUR_LINE_ID_12' } }, // Re-added sroiInfo for poi12
    { id: 'poi13', name: '謝家肉圓', coords: { lat: 23.817521, lng: 120.853831 }, icon: '🥟', description: '步行、摩托、台灣好行。營業時間 11:00–17:00。\n\n在地人巷內70年老店。', image: '', socialLink: 'https://www.facebook.com/profile.php?id=100054428473137&locale=zh_TW' },
    { id: 'poi14', name: '機車貓聯盟', coords: { lat: 23.810883, lng: 120.855798 }, icon: '🍚', description: '共乘、摩托、台灣好行。營業時間 11:00–17:00。\n\n無菜單料理店，50%以上使用在地食材，任一消費金額可獲得永續與環境教育任務點數10點。', image: '', socialLink: 'https://m.facebook.com/機車貓聯盟-552637305127422/' }, // Added social link (using the one from search result)
    { id: 'poi15', name: '二坪大觀冰店', coords: { lat: 23.813627, lng: 120.859651 }, icon: '🍦', description: '共乘、摩托。\n\n在地推薦古早味枝仔冰。台電員工福利社60年老店。', image: '', socialLink: 'https://www.facebook.com/2pinIce/' },
    { id: 'poi16', name: '水里里山村', coords: { lat: 23.813459, lng: 120.853787 }, icon: '🏡', description: '共乘、摩托。\n\n在地推鑑環保旅宿，任一消費金額可獲得永續與環境教育任務點數10點。', image: '', socialLink: 'https://tg-ecohotel.com/' }, // Added website link
    // Added isNew flag and updated description for poi17
    { id: 'poi17', name: '水里星光市集', coords: { lat: 23.813636, lng: 120.850816 }, icon: '💡', description: '共乘、摩托。\n\n任一消費金額可獲得永續與環境教育任務點數10點。\n\n本年度預計於星光市集舉辦「食農教育」活動，場次及內容請洽水里鄉商圈創生共好協會。', image: '', socialLink: 'https://www.facebook.com/p/%E6%B0%B4%E9%87%8C%E9%84%89%E5%95%86%E5%9C%88%E5%89%B5%E7%94%9F%E5%85%B1%E5%A5%BD%E5%8D%94%E6%9C%83-100076220760859/?locale=zh_TW', isNew: true, marketScheduleLink: 'https://www.facebook.com/photo/?fbid=2583695705169366&set=pcb.2583696081835995' } // Added isNew flag and marketScheduleLink
];

 // Sustainable Actions Data with points
 const sustainableActions = [
     { name: '支持在地飲食', points: 5 },
     { name: '減少剩食', points: 5 },
     { name: '自備環保用品', points: 5 },
     { name: '回收分類', points: 5 },
     { name: '保育行為', points: 10 },
     { name: '導覽參加', points: 10 },
     { name: '不破壞棲地', points: 10 },
     { name: '支持小農', points: 5 },
     { name: '遵守營火', points: 5 }
 ];


// Sustainable Activities Data
const activities = [
    // validCodes are now only used for reference, verification checks format only
    // TODO: Replace the placeholder image URL below with a permanent, publicly accessible URL for the SROI image
    { id: 'act1', name: 'SROI 社會責任農產品購買', points: 15, validCodes: ['ABC123', 'XYZ789'], image: 'https://placehold.co/400x200/4caf50/white?text=SROI+Image' }, // Added placeholder image URL with green color
    { id: 'act2', name: '生態棲地破冰活動', points: 20, validCodes: ['DEF456', 'UVW012'] },
    { id: 'act3', name: 'ESG社會責任活動講堂', points: 25, validCodes: ['GHI789', 'RST345'] },
    { id: 'act4', name: 'CBD里山生態廊道永續旅遊', points: 30, validCodes: ['JKL012', 'QRS678'] },
    { id: 'act5', name: '里山倡議食農下午茶講堂', points: 20, validCodes: ['MNO345', 'PQR901'] },
    { id: 'act6', name: '小白宮x山形工作室', points: 10, validCodes: ['PQR678', 'STU234'] },
    { id: 'act7', name: '其他永續與環境教育活動及課程', points: 10, validCodes: ['VWX901', 'YZA567'] }
    // Add more activities and valid codes as needed
];

// --- State Variables ---
let currentTransport = null; // This is for the *overall* selected transport on the homepage
let totalMileage = 0; // in meters
let totalCarbonReduction = 0; // in grams
let totalScore = 0;
let playerName = ''; // New state variable for player name
let playerCode = ''; // New state variable for player code
let map = null; // Google Map object
// Re-added Directions Service and Renderer
let directionsService = null; // Google Maps DirectionsService object
let directionsRenderer = null; // Google Maps DirectionsRenderer object
let poiMarkers = []; // Array to store Google Maps Marker objects
let selectedActivity = null; // To store the currently selected activity for verification
// Re-added selectedStartPoi and selectedEndPoi
let selectedStartPoi = null; // To store the selected start POI object
let selectedEndPoi = null; // To store the selected end POI object
let loggedActions = []; // Array to store sustainable action logs
let selectedSustainableActions = []; // Array to store selected sustainable action names

// New state variable for the currently selected POI in the log trip modal
let currentLogTripPoi = null;

// New state variable for network-wide total carbon reduction
let networkTotalCarbonReduction = 0;

// Define consumption data for poi17 with corresponding mileage in meters AND carbon reduction in grams
const poi17ConsumptionData = {
    農產品: { mileage: 5000, carbonReduction: 20 }, // 5 km = 5000 meters, 20g carbon reduction
    在地小吃: { mileage: 3000, carbonReduction: 12 }, // 3 km, 12g carbon reduction
    文創商品: { mileage: 2000, carbonReduction: 8 }, // 2 km, 8g carbon reduction
    服務類: { mileage: 2000, carbonReduction: 8 }, // 2 km, 8g carbon reduction
    其他: { mileage: 2000, carbonReduction: 8 } // 2 km, 8g carbon reduction
};


// --- DOM Elements ---
const homepageSection = document.getElementById('homepage');
const missionPageSection = document.getElementById('mission-page');
const thsrInfoDiv = document.getElementById('thsr-info'); // This div is now unused for display, kept for reference
const playerNameInput = document.getElementById('player-name'); // New input element for player name
const playerCodeDisplay = document.getElementById('player-code'); // New element to display player code
const totalMileageSpan = document.getElementById('total-mileage');
const totalCarbonReductionSpan = document.getElementById('total-carbon-reduction');
const totalScoreSpan = document.getElementById('total-score');
const currentTransportDisplay = document.getElementById('current-transport-display');
const mapElement = document.getElementById('map');
const mapStatusElement = document.getElementById('map-status'); // Get the map status element
// Re-added selectedPointsDisplay and calculateMileageButton
const selectedPointsDisplay = document.getElementById('selected-points-display'); // New element for selected points
const calculateMileageButton = document.getElementById('calculate-mileage-button'); // New button
// Re-added tripCalculationStatusElement
const tripCalculationStatusElement = document.getElementById('trip-calculation-status'); // New status element
const poiListElement = document.getElementById('poi-list');
const poiModal = document.getElementById('poi-modal');
const poiModalTitle = document.getElementById('poi-modal-title');
const poiModalImage = document.getElementById('poi-modal-image');
const poiModalDescription = document.getElementById('poi-modal-description');
const poiModalCoordinates = document.getElementById('poi-modal-coordinates');
const poiModalSocialDiv = document.getElementById('poi-modal-social'); // New element for social links in modal
// Re-added setAsStartButton and setAsEndButton
const setAsStartButton = document.getElementById('set-as-start-button'); // New button in modal
const setAsEndButton = document.getElementById('set-as-end-button'); // New button in modal
const activityModal = document.getElementById('activity-modal'); // Activity Modal
const selectedActivityNameElement = document.getElementById('selected-activity-name'); // Element to show selected activity name in modal
const verificationCodeInput = document.getElementById('verification-code-input'); // Input in Activity Modal
const activityContentInput = document.getElementById('activity-content-input'); // New input for activity content
const submitActivityLogButton = document.getElementById('submit-activity-log'); // Button in Activity Modal (renamed from submitVerificationCode)
const activityLogStatusElement = document.getElementById('activity-log-status'); // Status in Activity Modal (renamed from verificationStatus)
const activityListElement = document.getElementById('activity-list');
const participateActivityButton = document.getElementById('participate-activity-button'); // Participate button
const sustainableActionLogTextarea = document.getElementById('sustainable-action-log');
const logActionButton = document.getElementById('log-action-button');
const actionLogStatusElement = document.getElementById('action-log-status'); // Status for sustainable actions
const backToHomeButton = document.getElementById('back-to-home');
const changeTransportButton = document.getElementById('change-transport-button'); // New button
const loggedActionsListElement = document.getElementById('logged-actions-list'); // Element to display logged actions
const thsrInfoModal = document.getElementById('thsr-info-modal'); // THSR Info Modal
const selectableActionsListElement = document.getElementById('selectable-actions-list'); // Element to display selectable actions
const downloadDataButton = document.getElementById('download-data-button'); // New download button element
const activityModalImage = document.getElementById('activity-modal-image'); // Get the activity modal image element

// New DOM elements for Log Trip Modal
const logTripModal = document.getElementById('log-trip-modal');
const logTripPoiNameElement = document.getElementById('log-trip-poi-name');
const logTripTransportOptionsDiv = document.getElementById('log-trip-transport-options');
const logTripMileageInput = document.getElementById('log-trip-mileage');
const submitLogTripButton = document.getElementById('submit-log-trip');
const logTripStatusElement = document.getElementById('log-trip-status');
const logTripTransportStatusElement = document.getElementById('log-trip-transport-status'); // Status for transport selection
const logTripMileageStatusElement = document.getElementById('log-trip-mileage-status'); // Status for mileage input

// New DOM elements for Taxi Info Modal
const taxiInfoModal = document.getElementById('taxi-info-modal');
const taxiInfoButton = document.getElementById('taxi-info-button'); // Button to open taxi info modal

// New DOM elements for POI Review Section
const poiReviewSection = document.getElementById('poi-review-section');
const consumptionAmountInput = document.getElementById('consumption-amount');
const reviewCodeInput = document.getElementById('review-code');
const submitPoiReviewButton = document.getElementById('submit-poi-review');
const poiReviewStatusElement = document.getElementById('poi-review-status');

// New DOM elements for poi12 specific buttons
const poi12ButtonsDiv = document.getElementById('poi12-buttons');
// Re-added sroiOrderButton for poi12
const sroiOrderButtonPoi12 = document.getElementById('sroi-order-button-poi12');


// New DOM elements for SROI Info Modal
const sroiInfoModal = document.getElementById('sroi-info-modal');
const sroiModalPoiNameElement = document.getElementById('sroi-modal-poi-name');
const sroiModalContentBody = document.getElementById('sroi-modal-content-body');
const showSroiInfoButton = document.getElementById('show-sroi-info-button'); // Get the new SROI button

// New DOM element for network total carbon reduction display
const networkTotalCarbonReductionElement = document.getElementById('network-total-carbon-reduction');
const networkStatsStatusElement = document.getElementById('network-stats-status'); // Status for network stats

// Define consumption data for poi17 with corresponding mileage in meters AND carbon reduction in grams
const poi17ConsumptionData = {
    農產品: { mileage: 5000, carbonReduction: 20 }, // 5 km = 5000 meters, 20g carbon reduction
    在地小吃: { mileage: 3000, carbonReduction: 12 }, // 3 km, 12g carbon reduction
    文創商品: { mileage: 2000, carbonReduction: 8 }, // 2 km, 8g carbon reduction
    服務類: { mileage: 2000, carbonReduction: 8 }, // 2 km, 8g carbon reduction
    其他: { mileage: 2000, carbonReduction: 8 } // 2 km, 8g carbon reduction
};

// New DOM elements for poi17 consumption section
const poi17ConsumptionSection = document.getElementById('poi17-consumption-section');
const consumptionButtonsDiv = document.getElementById('consumption-buttons');
const consumptionCodeInput = document.getElementById('consumption-code-input');
const submitConsumptionButton = document.getElementById('submit-consumption');
const consumptionStatusElement = document.getElementById('consumption-status');


// --- Local Storage ---
const localStorageKey = 'shuilSustainableTourismData';
const localStorageActionsKey = 'shuilSustainableTourismActions'; // New key for actions

function loadData() {
    console.log("Loading data from localStorage..."); // Debugging line
    const data = localStorage.getItem(localStorageKey);
    if (data) {
        const parsedData = JSON.parse(data);
        totalMileage = parsedData.totalMileage || 0;
        totalCarbonReduction = parsedData.totalCarbonReduction || 0;
        totalScore = parsedData.totalScore || 0;
        playerName = parsedData.playerName || ''; // Load player name
        playerCode = parsedData.playerCode || ''; // Load player code

        // If player code is not loaded (first time or cleared data), generate a new one
        if (!playerCode) {
            playerCode = generateRandomCode();
            console.log("Generated new player code:", playerCode); // Debugging line
        } else {
             console.log("Loaded player code:", playerCode); // Debugging line
        }


        updateStatsDisplay();
         document.getElementById('stats-load-status').textContent = '已成功載入之前的旅遊數據。'; // Update status message
         document.getElementById('stats-load-status').classList.remove('text-gray-600');
         document.getElementById('stats-load-status').classList.add('text-green-600');

    } else {
         // If no data at all, generate a new code and initialize stats
         playerCode = generateRandomCode();
         totalMileage = 0;
         totalCarbonReduction = 0;
         totalScore = 0;
         playerName = '';
         console.log("No data found, generated new player code and initialized stats:", playerCode); // Debugging line
         updateStatsDisplay(); // Update display with initial stats and new code
         document.getElementById('stats-load-status').textContent = '未發現先前的旅遊數據，已建立新的永續旅者紀錄。'; // Update status message
         document.getElementById('stats-load-status').classList.remove('text-gray-600');
         document.getElementById('stats-load-status').classList.add('text-blue-600');
    }

    // Load action logs
    console.log("Loading action logs from localStorage..."); // Debugging line
    const actionsData = localStorage.getItem(localStorageActionsKey);
    if (actionsData) {
        loggedActions = JSON.parse(actionsData);
        console.log("Loaded action logs:", loggedActions); // Debugging line
        renderLoggedActions(); // Display loaded actions
    } else {
         loggedActions = []; // Initialize as empty array if no data
         loggedActionsListElement.innerHTML = '<p class="text-gray-500 text-center">尚無行動紀錄</p>'; // Show empty message if no data
         console.log("No action logs found."); // Debugging line
    }
     saveData(); // Save data including the potentially new code and initialized actions
     console.log("Data loading complete."); // Debugging line

     // Fetch and display network-wide total (only if Firebase initialized successfully)
    if (db) {
        fetchNetworkTotalCarbonReduction();
    } else {
         console.warn("Firebase not initialized, cannot fetch network total.");
    }
}

function saveData() {
    console.log("Saving data to localStorage..."); // Debugging line
    const dataToSave = {
        totalMileage: totalMileage,
        totalCarbonReduction: totalCarbonReduction,
        totalScore: totalScore,
        playerName: playerNameInput.value.trim(), // Save player name from input
        playerCode: playerCode // Save player code
    };
    localStorage.setItem(localStorageKey, JSON.stringify(dataToSave));
    console.log("Saved main data:", dataToSave); // Debugging line


    // Save action logs
    localStorage.setItem(localStorageActionsKey, JSON.stringify(loggedActions));
    console.log("Saved action logs:", loggedActions); // Debugging line

    // Send player data to Firebase (only if Firebase initialized successfully)
    if (db && playerCode) { // Ensure playerCode exists before saving to Firebase
       savePlayerDataToFirebase({
           playerCode: playerCode,
           playerName: playerNameInput.value.trim(),
           totalMileage: totalMileage,
           totalCarbonReduction: totalCarbonReduction,
           totalScore: totalScore,
           lastUpdated: serverTimestamp() // Use the imported serverTimestamp function
       });
    } else {
        console.warn("Firebase not initialized or player code missing, cannot save player data.");
    }
}

function updateStatsDisplay() {
    totalMileageSpan.textContent = `${(totalMileage / 1000).toFixed(2)} km`; // Display in km
    totalCarbonReductionSpan.textContent = `${totalCarbonReduction.toFixed(2)} g`;
    totalScoreSpan.textContent = totalScore;
    playerNameInput.value = playerName; // Set player name input value
    playerCodeDisplay.textContent = playerCode; // Display player code
    console.log("Stats display updated."); // Debugging line
}

// --- Generate Random Code ---
function generateRandomCode() {
    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const digits = '0123456789';
    let code = '';
    // 3 random letters
    for (let i = 0; i < 3; i++) {
        code += letters.charAt(Math.floor(Math.random() * letters.length));
    }
    // 5 random digits
    for (let i = 0; i < 5; i++) {
        code += digits.charAt(Math.floor(Math.random() * digits.length));
    }
    return code;
}

// --- Firebase Integration ---

// Function to save individual player data to Firebase
async function savePlayerDataToFirebase(playerData) {
    console.log("Attempting to save player data to Firebase for永續旅者:", playerData.playerCode); // Debugging line
     // Check if db is initialized before proceeding
     if (!db) {
          console.error("Firebase Firestore not initialized. Cannot save永續旅者data.");
          return;
     }
    try {
        // Use playerCode as the document ID in the 'players' collection
        // Use the imported collection and doc functions
        const playerDocRef = doc(collection(db, 'players'), playerData.playerCode);


        // Use set with merge: true to create or update the document
        // Use the imported setDoc function
        await setDoc(playerDocRef, playerData, { merge: true });


        console.log("永續旅者data saved to Firebase successfully for永續旅者:", playerData.playerCode); // Debugging line
        // After saving, fetch the updated network total (which sums all player data)
        fetchNetworkTotalCarbonReduction();

    } catch (e) {
        console.error("Error saving 永續旅者 data to Firebase: ", e); // Debugging line
        // Optional: Display an error message to the user
    }
}


// Function to fetch and display network-wide total carbon reduction from Firebase
async function fetchNetworkTotalCarbonReduction() {
    console.log("Attempting to fetch network total carbon reduction from Firebase..."); // Debugging line
     // Check if db is initialized before proceeding
     if (!db) {
          console.error("Firebase Firestore not initialized. Cannot fetch data.");
          networkTotalCarbonReductionElement.textContent = '載入失敗';
          networkStatsStatusElement.textContent = 'Firebase 未初始化。';
          networkStatsStatusElement.classList.remove('text-gray-600', 'text-green-600');
          networkStatsStatusElement.classList.add('text-red-600');
          return;
     }

    networkTotalCarbonReductionElement.textContent = '載入中...';
    networkStatsStatusElement.textContent = '從伺服器載入中...';
    networkStatsStatusElement.classList.remove('text-green-600', 'text-red-600', 'text-blue-600'); // Remove all previous status colors
    networkStatsStatusElement.classList.add('text-gray-600'); // Set to gray for loading


    try {
        // Get all documents in the 'players' collection
        // Use the imported collection and getDocs functions
        const playersSnapshot = await getDocs(collection(db, 'players'));


        let totalCarbonAcrossNetwork = 0;

        if (!playersSnapshot.empty) {
            playersSnapshot.forEach(doc => {
                const playerData = doc.data();
                // Add each player's totalCarbonReduction to the network total
                totalCarbonAcrossNetwork += (playerData.totalCarbonReduction || 0); // Use 0 if value is missing
            });
             console.log(`Workspaceed ${playersSnapshot.size} 永續旅者documents.`); // Debugging line
        } else {
             console.log("No 永續旅者data found in Firebase 'players' collection."); // Debugging line
        }

        networkTotalCarbonReduction = totalCarbonAcrossNetwork; // Update the state variable
        networkTotalCarbonReductionElement.textContent = `${networkTotalCarbonReduction.toFixed(2)} g`;
        networkStatsStatusElement.textContent = '網路統計數據載入成功。';
        networkStatsStatusElement.classList.remove('text-gray-600', 'text-red-600', 'text-blue-600');
        networkStatsStatusElement.classList.add('text-green-600');
        console.log("Network total carbon reduction calculated and displayed:", networkTotalCarbonReduction, "g"); // Debugging line


    } catch (e) {
        console.error("Error fetching network total carbon reduction from Firebase: ", e); // Debugging line
        networkTotalCarbonReduction = 0; // Reset to 0 on error
        networkStatsStatusElement.textContent = '無法載入網路統計數據。';
        networkStatsStatusElement.classList.remove('text-gray-600', 'text-green-600', 'text-blue-600');
        networkStatsStatusElement.classList.add('text-red-600');
    }
}


// --- Page Navigation ---
function showHomepage() {
    homepageSection.style.display = 'block';
    missionPageSection.style.display = 'none';
     // Reset selected points and clear trip line when returning to homepage
    resetSelectedPoints(); // Re-added resetSelectedPoints
    clearTripLine(); // Re-added clearTripLine
     // Clear selected actions when returning to homepage
     clearSelectedActions();
     // Clear selected activity state
     selectedActivity = null;
      // Remove highlight from previously selected activity item
     const previousSelectedItem = activityListElement.querySelector(`.selected-activity-item`);
     if (previousSelectedItem) {
                 previousSelectedItem.classList.remove('selected-activity-item');
     }
     console.log("Showing homepage."); // Debugging line
     // Ensure network total is fetched/updated when returning to homepage
    if (db) {
        fetchNetworkTotalCarbonReduction();
    } else {
         console.warn("Firebase not initialized, cannot fetch network total on homepage.");
    }
}
// Using the new variable for the element
const backToHomeButton = document.getElementById('back-to-home');
if (backToHomeButton) {
    backToHomeButton.addEventListener('click', showHomepage);
    console.log("Back to home button listener added.");
} else {
    console.error("Element with ID 'back-to-home' not found.");
}


const changeTransportButton = document.getElementById('change-transport-button');
if (changeTransportButton) {
    changeTransportButton.addEventListener('click', showHomepage);
    console.log("Change transport button listener added.");
} else {
    console.error("Element with ID 'change-transport-button' not found.");
}


const downloadDataButton = document.getElementById('download-data-button');
if (downloadDataButton) {
    downloadDataButton.addEventListener('click', downloadTourismData);
    console.log("Download data button listener added.");
} else {
    console.error("Element with ID 'download-data-button' not found.");
}


const taxiInfoButton = document.getElementById('taxi-info-button');
if (taxiInfoButton) {
    taxiInfoButton.addEventListener('click', showTaxiInfoModal);
    console.log("Taxi Info button listener added.");
} else {
    console.error("Element with ID 'taxi-info-button' not found.");
}


// These elements need to be selected by their ID in `script.js` too
const poi17ConsumptionSection = document.getElementById('poi17-consumption-section');
const consumptionButtonsDiv = document.getElementById('consumption-buttons');
const consumptionCodeInput = document.getElementById('consumption-code-input');
const submitConsumptionButton = document.getElementById('submit-consumption');
const consumptionStatusElement = document.getElementById('consumption-status');

// Add event listener for the submit consumption button
if (submitConsumptionButton) {
    submitConsumptionButton.addEventListener('click', submitConsumption);
    console.log("Submit consumption button listener added.");
} else {
    console.error("Element with ID 'submit-consumption' not found.");
}
